.. EN-Revision: none
.. _zend.log.overview:

概要
==

``Zend_Log`` は、ログ出力用の汎用コンポーネントです。
複数のバックエンドに対応しており、ログに出力するメッセージをフォーマットしたり
記録するメッセージをフィルタリングしたりできます。
これらの関数は、以下のオブジェクトに分けられています。



   - ログ (``Zend_Log`` のインスタンス) は、
     アプリケーション内でもっともよく使用するオブジェクトです。
     いくつでも望みの数だけのログオブジェクトを保持できます。
     それらが互いに影響しあうことはありません。
     ログオブジェクトには最低ひとつのライターが含まれる必要があり、
     オプションでひとつあるいは複数のフィルタを含むことができます。

   - ライター (``Zend\Log_Writer\Abstract`` を継承したもの)
     は、データを保存する役割を受け持ちます。

   - フィルタ (``Zend\Log_Filter\Interface`` を実装したもの)
     は、保存するログデータをブロックします。
     フィルタは個々のライターに適用することもできますし、
     ログに適用することもできます。ログに適用した場合は、
     すべてのライターの前に適用されます。どちらの場合についても、
     複数のフィルタを連結することが可能です。

   - フォーマッタ (``Zend\Log_Formatter\Interface`` を実装したもの)
     は、ログのデータをライターに書き出す前に書式設定できます。
     個々のライターは、それぞれひとつのフォーマッタを保持しています。



.. _zend.log.overview.creating-a-logger:

ログの作成
-----

ログの記録を開始するには、ライターのインスタンスを作成し、
それをログのインスタンスに渡します。

.. code-block:: php
   :linenos:

   $logger = new Zend\Log\Log();
   $writer = new Zend\Log_Writer\Stream('php://output');

   $logger->addWriter($writer);

注意すべき点は、ログには最低ひとつのライターが必要であるということです。
ライターはお好みの数だけ追加できます。追加するには ログの ``addWriter()``
メソッドを使用します。

一方、ログのコンストラクタで直接ライターを指定することも可能です。

.. code-block:: php
   :linenos:

   $writer = new Zend\Log_Writer\Stream('php://output');
   $logger = new Zend\Log\Log($writer);

これで、ログが使用できるようになりました。

.. _zend.log.overview.logging-messages:

メッセージの記録
--------

メッセージをログに記録するには、ログのインスタンスの ``log()``
メソッドを実行し、メッセージと優先度を渡します。

.. code-block:: php
   :linenos:

   $logger->log('Informational message', Zend\Log\Log::INFO);

``log()`` メソッドの最初のパラメータはメッセージを表す文字列で、
二番目のパラメータは優先度を表す整数値です。
優先度は、ログのインスタンスが理解できる形式の値のいずれかでなければなりません。
これについては次の節で説明します。

こちらも別の方法が使用できます。 ``log()`` メソッドをコールするかわりに、
優先度と同じ名前のメソッドをコールできます。

.. code-block:: php
   :linenos:

   $logger->log('Informational message', Zend\Log\Log::INFO);
   $logger->info('Informational message');

   $logger->log('Emergency message', Zend\Log\Log::EMERG);
   $logger->emerg('Emergency message');

.. _zend.log.overview.destroying-a-logger:

ログの破棄
-----

ログオブジェクトが不要になったら、ログオブジェクトを指す変数に ``NULL``
を代入してそれを破棄しましょう。これは、
アタッチされている各ライターのインスタンスメソッド ``shutdown()``
をコールしてからログオブジェクトを破棄します。

.. code-block:: php
   :linenos:

   $logger = null;

このように明示的にログを破棄することは必須ではありません。 *PHP*
の終了時に、この処理が自動的に行われます。

.. _zend.log.overview.builtin-priorities:

組み込みの優先度の使用
-----------

``Zend_Log`` クラスでは以下の優先度を定義しています。

.. code-block:: php
   :linenos:

   EMERG   = 0;  // 緊急事態 (Emergency): システムが使用不可能です
   ALERT   = 1;  // 警報 (Alert): 至急対応が必要です
   CRIT    = 2;  // 危機 (Critical): 危機的な状況です
   ERR     = 3;  // エラー (Error): エラーが発生しました
   WARN    = 4;  // 警告 (Warning): 警告が発生しました
   NOTICE  = 5;  // 注意 (Notice): 通常動作ですが、注意すべき状況です
   INFO    = 6;  // 情報 (Informational): 情報メッセージ
   DEBUG   = 7;  // デバッグ (Debug): デバッグメッセージ

これらの優先度は常に使用可能で、それぞれについて
同じ名前のメソッドが用意されています。

これらの優先度は適当に指定しているわけではありません。 もとは BSD の *syslog*
プロトコルに由来するもので、 `RFC-3164`_
で示されています。それぞれの名前と優先度番号は、 *PHP*
におけるもうひとつのログ記録システムである `PEAR Log`_
とも互換性があります。おそらく、これと ``Zend_Log`` は相互運用できるでしょう。

優先度の数値が小さいほど優先度が高くなります。 *EMERG* (0) が最重要な優先度で、
``DEBUG`` (7) は 組み込みの優先度の中ではもっとも優先度が低いものです。 ``DEBUG``
より低い優先度を定義することもできます。
メッセージをログに記録する際には、この優先度の階層に注意し、適切なものを選択するようにしましょう。

.. _zend.log.overview.user-defined-priorities:

ユーザ定義の優先度の追加
------------

ユーザ定義の優先度を実行時に追加するには、ログの ``addPriority()``
メソッドを使用します。

.. code-block:: php
   :linenos:

   $logger->addPriority('FOO', 8);

上の例では、新しい優先度 ``FOO`` を *8*
という値で定義しています。これで、次のようにして新しい優先度でログ出力できるようになります。

.. code-block:: php
   :linenos:

   $logger->log('Foo message', 8);
   $logger->foo('Foo Message');

新しい優先度は、既存のものを上書きすることはできません。

.. _zend.log.overview.understanding-fields:

ログのイベントについて理解する
---------------

``log()`` メソッドやその仲間をコールした際に、
ログのイベントが作成されます。これは単純な連想配列で、
ライターに渡されるイベントの内容を表します。この配列には、 *timestamp*\ 、 *message*\
、 *priority* および *priorityName* のキーが常に存在します。

*event* 配列の作成は完全に透過的です。 しかし、 *event*
配列について知っておかないと、
上で示した既存のセットに含まれない項目を追加できません。

将来のイベントにたいして常に特定の項目を追加するようにするには、 ``setEventItem()``
メソッドをコールしてキーと値を指定します。

.. code-block:: php
   :linenos:

   $logger->setEventItem('pid', getmypid());

上の例は、 *pid* という名前の新しい項目を作成して現在のプロセスの PID
を格納します。新しい値が設定されると、他のすべてのイベントデータと同様に
すべてのライターから自動的にアクセス可能となります。項目を上書きするには、
もう一度好きなときに ``setEventItem()`` メソッドをコールします。

新しいイベント項目を ``setEventItem()`` で設定すると、
ロガーのすべてのライターに新しい項目を送信します。しかし、
これはそれらのライターが実際にその項目を書き出すことを保証するものではありません。
フォーマッタオブジェクトがその新しい項目のことを教えない限り、
ライターはそれをどう扱っていいのかわからないからです。
さらに詳しく学ぶには、フォーマッタの節を参照ください。

.. _zend.log.overview.as-errorHandler:

Log PHP Errors
--------------

``Zend_Log`` can also be used to log *PHP* errors. Calling ``registerErrorHandler()`` will add ``Zend_Log`` before
the current error handler, and will pass the error along as well.

.. _zend.log.overview.as-errorHandler.properties.table-1:

.. table:: Zend_Log events from PHP errors have the additional fields matching handler ( int $errno , string $errstr [, string $errfile [, int $errline [, array $errcontext ]]] ) from set_error_handler

   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   |Name   |Error Handler Parameter|Description                                                                                                                                                                                                                                                           |
   +=======+=======================+======================================================================================================================================================================================================================================================================+
   |message|errstr                 |Contains the error message, as a string.                                                                                                                                                                                                                              |
   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   |errno  |errno                  |Contains the level of the error raised, as an integer.                                                                                                                                                                                                                |
   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   |file   |errfile                |Contains the filename that the error was raised in, as a string.                                                                                                                                                                                                      |
   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   |line   |errline                |Contains the line number the error was raised at, as an integer.                                                                                                                                                                                                      |
   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   |context|errcontext             |(optional) An array that points to the active symbol table at the point the error occurred. In other words, errcontext will contain an array of every variable that existed in the scope the error was triggered in. User error handler must not modify error context.|
   +-------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+



.. _`RFC-3164`: http://tools.ietf.org/html/rfc3164
.. _`PEAR Log`: http://pear.php.net/package/log
